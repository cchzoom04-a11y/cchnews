<!doctype html>
<html lang="zh-Hant">
 <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>æ–°èç™¼å¸ƒæ¥­å‹™é€²åº¦v2.0</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;800&amp;display=swap" rel="stylesheet">
  <style>
  :root{
    --ink:#111111;
    --muted:#6B7280;
    --line:#E6E6E6;
    --accent:#D80000;
    --soft-red:#FFFAFA;
    --soft-red-line:#FFDDDD;
    --blue:#2563EB;
    --green:#059669; 
    --soft-green: #D1FAE5;
    --soft-green-line: #10B981;
    --purple:#7C3AED;
    --soft-purple:#F8F5FF;
    --soft-purple-line:#E0D4FF;
  }
  *{box-sizing:border-box}
  body{
    font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
    color:var(--ink); background:#fff; margin:0; line-height:1.5;
  }
  .wrap{max-width:1200px;margin:40px auto;padding:0 24px}
  
  /* æ¨™é¡Œèˆ‡åˆ‡æ›å€å¡Š */
  .header-area {
    display: flex; flex-direction: column; align-items: center; margin-bottom: 28px; position: relative;
  }
  h1{font-weight:800;font-size:52px;letter-spacing:.5px;text-align:center;margin:0 0 16px}
  
  .view-toggle {
    display: flex; background: #f1f5f9; padding: 4px; border-radius: 8px;
  }
  .view-btn {
    padding: 8px 24px; border: none; background: transparent; cursor: pointer;
    font-size: 14px; font-weight: 600; color: var(--muted); border-radius: 6px;
    transition: all 0.2s;
  }
  .view-btn.active {
    background: white; color: var(--blue); box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  /* åŸå§‹å¡ç‰‡æ¨£å¼ */
  .card{
    display:grid; grid-template-columns:140px 1fr 240px; gap:24px;
    border:2px solid var(--line); border-radius:16px; padding:16px 20px; margin:0 0 20px;
    background:#fff; position:relative;
    transition: box-shadow 0.3s ease, border-color 0.3s ease;
  }
  /* è·³è½‰æ™‚çš„é«˜äº®æ¨£å¼ */
  .card.highlight-focus {
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.4);
    border-color: var(--blue);
  }

  /* --- é¡è‰²ä¸»é¡Œæ¨£å¼ (æ–°å¢ Green) --- */
  .card.accent{border-color:var(--soft-red-line); background:var(--soft-red)}
  .card.purple{border-color:var(--soft-purple-line); background:var(--soft-purple)}
  /* æ–°å¢ï¼šç¶ è‰²å¡ç‰‡æ¨£å¼ */
  .card.green{border-color:var(--soft-green-line); background:var(--soft-green)}

  .date{
    padding-right:20px; border-right:2px solid var(--line);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    text-align:center;
  }
  .date .label,.date .weekday{font-size:14px;color:var(--muted);letter-spacing:1px}
  .date .day{font-size:56px;font-weight:800;line-height:1}
  
  /* æ—¥æœŸé¡è‰²é€£å‹• */
  .card.accent .date .label,
  .card.accent .date .day,
  .card.accent .date .weekday{color:var(--accent)}
  
  .card.purple .date .label,
  .card.purple .date .day,
  .card.purple .date .weekday{color:var(--purple)}

  /* æ–°å¢ï¼šç¶ è‰²æ—¥æœŸæ–‡å­—é¡è‰² */
  .card.green .date .label,
  .card.green .date .day,
  .card.green .date .weekday{color:var(--green)}
  
  .content{display:flex; flex-direction: column; justify-content: center;}
  .content h2{margin:0; font-size:40px; line-height:1.15; font-weight:800}
  .content h2.red{color:var(--accent)}
  .content h2.purple{color:var(--purple)}
  /* æ–°å¢ï¼šç¶ è‰²æ¨™é¡Œé¡è‰² */
  .content h2.green{color:var(--green)}
  
  /* å‚™è¨»æ¨£å¼ */
  .content .note{
    font-size: 15px; color: #555; margin-top: 10px; font-weight: 400;
    background-color: #f3f4f6; padding: 6px 12px; border-radius: 6px;
    border-left: 3px solid #cbd5e1; line-height: 1.5; white-space: pre-wrap;
  }

  .meta{
    padding-left:20px; border-left:2px solid var(--line);
    background:#F7F7F7; border-radius:12px; padding:12px 16px; display:flex; flex-direction:column; justify-content:center
  }
  .meta .row{margin:4px 0; font-size:16px}
  .meta .key{color:var(--muted); margin-right:6px}

  /* æœˆæ›†æ¨¡å¼æ¨£å¼ */
  #calendarContainer {
    display: none; width: 100%;
  }
  .calendar-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
  }
  .calendar-header h2 { margin: 0; font-size: 24px; }
  .calendar-nav-btn {
    background: white; border: 1px solid var(--line); padding: 8px 16px; border-radius: 6px; cursor: pointer;
  }
  .calendar-nav-btn:hover { background: #f9fafb; }

  .calendar-grid {
    display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;
  }
  .calendar-day-header {
    text-align: center; font-weight: 600; color: var(--muted); padding: 8px;
  }
  .calendar-cell {
    background: white; border: 1px solid var(--line); border-radius: 8px; min-height: 120px;
    padding: 8px; display: flex; flex-direction: column; gap: 4px;
    position: relative;
  }
  .calendar-cell.other-month {
    background: #f9fafb; opacity: 0.6;
  }
  
  /* æœˆæ›†ä¸­çš„äº‹ä»¶æ¨£å¼ */
  .calendar-event {
    font-size: 13px; padding: 4px 8px; border-radius: 4px; cursor: pointer;
    background: white; border: 1px solid var(--line); box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    margin-bottom: 2px;
    transition: transform 0.1s;
  }
  .calendar-event:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  /* æ–‡å­—é¡è‰²æ¨£å¼ */
  .calendar-event.text-green {
    color: var(--green) !important;
    font-weight: 700;
    border-color: var(--soft-green-line);
    background-color: var(--soft-green);
  }
  .calendar-event.text-red {
    color: var(--accent) !important;
    font-weight: 700;
    border-color: var(--soft-red-line);
    background-color: var(--soft-red);
  }
  .calendar-event.text-purple {
    color: var(--purple) !important;
    font-weight: 700;
    border-color: var(--soft-purple-line);
    background-color: var(--soft-purple);
  }
  .calendar-event.text-black {
    color: var(--ink) !important;
  }
  
  .day-number {
    font-weight: 800; color: var(--muted); margin-bottom: 4px; font-size: 14px;
    display: flex; justify-content: space-between; align-items: center;
  }

  /* æœªå®šæ—¥æœŸå€å¡Š */
  .unscheduled-area {
    margin-bottom: 24px; padding: 16px; background: #fdfdfd; 
    border: 2px dashed var(--line); border-radius: 12px;
  }
  .unscheduled-title { font-size: 14px; font-weight: 600; color: var(--muted); margin-bottom: 8px; }
  .unscheduled-list { display: flex; flex-wrap: wrap; gap: 8px; }


  /* ç®¡ç†åŠŸèƒ½æ¨£å¼ */
  .admin-btn{
    position:fixed; top:20px; right:20px; 
    background:var(--blue); color:white; border:none; padding:12px 20px; 
    border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;
    box-shadow:0 4px 12px rgba(37,99,235,0.3); z-index:100;
  }
  .admin-btn:hover{background:#1d4ed8}

  .edit-btn{
    position:absolute; top:16px; right:16px;
    background:var(--green); color:white; border:none; padding:8px 12px;
    border-radius:6px; cursor:pointer; font-size:12px; opacity:0; transition:opacity 0.3s;
    display:none;
  }
  .admin-mode .edit-btn{opacity:1; display:block}
  .edit-btn:hover{background:#047857}

  .add-btn{
    background:var(--blue); color:white; border:none; padding:16px 32px;
    border-radius:12px; cursor:pointer; font-size:16px; font-weight:600;
    margin:20px auto; display:none; box-shadow:0 4px 12px rgba(37,99,235,0.3);
  }
  .admin-mode .add-btn{display:block}
  .add-btn:hover{background:#1d4ed8}

  /* æ¨¡æ…‹æ¡†æ¨£å¼ */
  .modal{
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;
  }
  .modal.show{display:flex}
  .modal-content{
    background:white; padding:32px; border-radius:16px; width:500px; max-width:90%;
    box-shadow:0 20px 60px rgba(0,0,0,0.3); max-height:90vh; overflow-y:auto;
  }
  .modal h3{margin:0 0 24px; font-size:24px; text-align:center; font-weight:800}
  
  .form-group{margin:20px 0}
  .form-group label{display:block; margin-bottom:8px; font-weight:600; color:var(--ink)}
  .form-group input, .form-group select, .form-group textarea{
    width:100%; padding:12px 16px; border:2px solid var(--line); border-radius:8px;
    font-size:16px; font-family:inherit; transition:border-color 0.3s;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus{
    outline:none; border-color:var(--blue);
  }
  .form-group textarea{resize:vertical; min-height:100px}
  .form-group textarea.short{min-height:80px; height: 80px;}
  
  .btn{
    background:var(--blue); color:white; border:none; padding:12px 24px;
    border-radius:8px; cursor:pointer; font-size:16px; font-weight:600; margin:8px 4px;
    transition:background-color 0.3s;
  }
  .btn:hover{background:#1d4ed8}
  .btn.secondary{background:var(--muted)}
  .btn.secondary:hover{background:#4b5563}
  .btn.danger{background:var(--accent)}
  .btn.danger:hover{background:#b91c1c}

  /* äººå“¡ç®¡ç†æ¨£å¼ */
  .staff-section{
    margin:24px 0; padding:20px; background:#f8f9fa; border-radius:12px;
  }
  .staff-section h4{margin:0 0 16px; font-size:18px; font-weight:600}
  .staff-list{
    display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:12px; margin:16px 0;
  }
  .staff-item{
    background:white; padding:12px 16px; border-radius:8px; border:1px solid var(--line);
    display:flex; justify-content:space-between; align-items:center;
  }
  .remove-staff{
    background:var(--accent); color:white; border:none; padding:6px 12px;
    border-radius:4px; cursor:pointer; font-size:12px;
  }
  .remove-staff:hover{background:#b91c1c}

  /* æª”æ¡ˆä¸Šå‚³æ¨£å¼ */
  .file-upload{
    border:2px dashed var(--line); border-radius:8px; padding:30px;
    text-align:center; cursor:pointer; transition:all 0.3s;
    background:#fafafa;
  }
  .file-upload:hover{border-color:var(--blue); background:#f0f8ff}
  .file-upload input{display:none}
  .file-upload p{margin:0; color:var(--muted)}
  .file-upload small{color:var(--muted); font-size:12px}

  .checkbox-group{
    display:flex; align-items:center; gap:8px; margin:16px 0;
  }
  .checkbox-group input[type="checkbox"]{
    width:auto; margin:0;
  }

  /* è¼‰å…¥ä¸­é®ç½© */
  #loadingOverlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.7); z-index: 9998;
    align-items: center; justify-content: center;
  }
  #loadingSpinner {
    border: 6px solid var(--line); border-top: 6px solid var(--blue);
    border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
  }
  #loadingOverlay.show { display: flex; }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  @media (max-width:900px){
    .card{grid-template-columns:1fr; }
    .date{border-right:0; border-bottom:2px solid var(--line); padding-bottom:12px; margin-bottom:8px}
    .meta{border-left:0; margin-top:8px}
    .content h2{font-size:28px}
    .date .day{font-size:42px}
    .modal-content{width:95%; padding:20px}
    .admin-btn{position:static; margin:20px auto; display:block; width:fit-content}
    /* æœˆæ›† RWD */
    .calendar-cell { min-height: 80px; }
  }
</style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  
  <div id="loadingOverlay">
    <div id="loadingSpinner"></div>
  </div>
  <button class="admin-btn" onclick="showLoginModal()">ç®¡ç†å¾Œå°</button>
  
  <div class="wrap">
   
   <div class="header-area">
     <h1>æ–°èç™¼å¸ƒæ¥­å‹™é€²åº¦v2.0</h1>
     <div class="view-toggle">
       <button class="view-btn active" onclick="switchView('board')" id="btnBoard">çœ‹æ¿æ¨¡å¼</button>
       <button class="view-btn" onclick="switchView('calendar')" id="btnCalendar">æœˆæ›†æ¨¡å¼</button>
     </div>
   </div>

   <div style="text-align:center; margin:20px 0">
     <button class="add-btn" onclick="addNews()">+ æ–°å¢æ–°è</button> 
     <button class="add-btn" onclick="showHistoryModal()" style="background:var(--muted); margin-left:12px">ğŸ“š æ­·å²ç´€éŒ„</button>
   </div>
   
   <div id="newsContainer"></div>
   
   <div id="calendarContainer">
     <div class="calendar-header">
       <button class="calendar-nav-btn" onclick="changeMonth(-1)">â—€ ä¸Šå€‹æœˆ</button>
       <h2 id="currentMonthLabel">2024å¹´ 5æœˆ</h2>
       <button class="calendar-nav-btn" onclick="changeMonth(1)">ä¸‹å€‹æœˆ â–¶</button>
     </div>
     
     <div id="unscheduledArea" class="unscheduled-area" style="display:none;">
        <div class="unscheduled-title">ğŸ“… æ—¥æœŸæœªå®šæ–°è</div>
        <div class="unscheduled-list" id="unscheduledList"></div>
     </div>

     <div class="calendar-grid" id="calendarGrid">
       </div>
   </div>

  </div>

  <div id="loginModal" class="modal">
   <div class="modal-content">
    <h3>ğŸ” ç®¡ç†å“¡ç™»å…¥</h3>
    <div class="form-group"><label>è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ï¼š</label> <input type="password" id="adminPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" onkeypress="if(event.key==='Enter') login()">
    </div>
    <div style="text-align:center"><button class="btn" onclick="login()">ç™»å…¥</button> <button class="btn secondary" onclick="closeModal('loginModal')">å–æ¶ˆ</button>
    </div>
   </div>
  </div>

  <div id="editModal" class="modal">
   <div class="modal-content">
    <h3 id="editTitle">ç·¨è¼¯æ–°è</h3>
    <div class="form-group"><label>ğŸ“… ç™¼å¸ƒæ—¥æœŸï¼š</label> <input type="date" id="editDate" required>
    </div>
    <div class="form-group"><label>ğŸ“° æ–°èæ¨™é¡Œï¼š</label> <textarea id="editNewsTitle" placeholder="è«‹è¼¸å…¥æ–°èæ¨™é¡Œ" required></textarea>
    </div>
    <div class="form-group"><label>ğŸ“ å‚™è¨»äº‹é …ï¼š</label> <textarea id="editNewsNote" class="short" placeholder="è«‹è¼¸å…¥å‚™è¨»èªªæ˜ï¼ˆé¸å¡«ï¼Œå­—é«”è¼ƒå°é¡¯ç¤ºæ–¼æ¨™é¡Œä¸‹æ–¹ï¼‰"></textarea>
    </div>
    
    <div class="form-group"><label>âœï¸ ç·¨è¼¯äººå“¡ï¼š</label> <select id="editEditor" required> <option value="">è«‹é¸æ“‡ç·¨è¼¯äººå“¡</option> </select>
    </div>
    <div class="form-group"><label>ğŸ¬ å½±ç‰‡äººå“¡ï¼š</label> <select id="editVideo" required> <option value="">è«‹é¸æ“‡å½±ç‰‡äººå“¡</option> </select>
    </div>
    <div class="form-group"><label>ğŸ¨ å¹³é¢äººå“¡ï¼š</label> <select id="editGraphic" required> <option value="">è«‹é¸æ“‡å¹³é¢äººå“¡</option> </select>
    </div>
    <div class="checkbox-group"><input type="checkbox" id="editAccent"> <label for="editAccent">â­ é‡é»æ–°èï¼ˆç´«è‰²æ¨™ç¤ºï¼‰</label>
    </div>
    <div style="text-align:center; margin-top:32px"><button class="btn" onclick="saveNews()">ğŸ’¾ å„²å­˜</button> <button class="btn danger" onclick="deleteNews()" id="deleteBtn">âœ… å®Œæˆæ–°è</button> <button class="btn secondary" onclick="closeModal('editModal')">å–æ¶ˆ</button>
    </div>
   </div>
  </div>

  <div id="historyModal" class="modal">
   <div class="modal-content" style="width:900px; max-width:95%; max-height:90vh">
    <h3>ğŸ“š æ–°èæ­·å²ç´€éŒ„</h3><div class="staff-section">
     <h4>ğŸ” æœå°‹æ¢ä»¶</h4>
     <div style="display:grid; grid-template-columns:1fr 1fr 2fr auto; gap:12px; margin-bottom:16px"><select id="searchYear"> <option value="">é¸æ“‡å¹´ä»½</option> </select> <select id="searchMonth"> <option value="">é¸æ“‡æœˆä»½</option> <option value="1">1æœˆ</option> <option value="2">2æœˆ</option> <option value="3">3æœˆ</option> <option value="4">4æœˆ</option> <option value="5">5æœˆ</option> <option value="6">6æœˆ</option> <option value="7">7æœˆ</option> <option value="8">8æœˆ</option> <option value="9">9æœˆ</option> <option value="10">10æœˆ</option> <option value="11">11æœˆ</option> <option value="12">12æœˆ</option> </select> <input type="text" id="searchKeyword" placeholder="è¼¸å…¥é—œéµå­—æœå°‹æ¨™é¡Œå…§å®¹..."> <button class="btn" onclick="searchHistory()">æœå°‹</button>
     </div>
     <div style="text-align:center"><button class="btn secondary" onclick="clearSearch()" style="font-size:14px; padding:8px 16px">æ¸…é™¤æ¢ä»¶</button> <span id="searchResults" style="margin-left:16px; color:var(--muted); font-size:14px"></span>
     </div>
    </div><div class="staff-section">
     <h4>ğŸ“° æ­·å²æ–°è (<span id="historyCount">0</span>)</h4>
     <div id="historyList" style="max-height:400px; overflow-y:auto; border:1px solid var(--line); border-radius:8px; padding:16px; background:white"></div>
    </div>
    <div style="text-align:center; margin-top:32px"><button class="btn" onclick="downloadHistoryExcel()" style="background:var(--green); margin-right:12px">ğŸ“¥ ä¸‹è¼‰Excel</button> <button class="btn secondary" onclick="closeModal('historyModal')">é—œé–‰</button>
    </div>
   </div>
  </div>

  <div id="staffModal" class="modal">
   <div class="modal-content" style="width:800px; max-width:95%">
    <h3>ğŸ‘¥ ç®¡ç†å¾Œå°</h3><div class="staff-section">
     <h4>ğŸ“° æ–°èç®¡ç†</h4>
     <div style="text-align:center; margin:16px 0"><button class="btn" onclick="addNews()">â• æ–°å¢æ–°è</button>
     </div>
     <div id="adminNewsList" style="max-height:300px; overflow-y:auto; border:1px solid var(--line); border-radius:8px; padding:16px; background:white"></div>
    </div>
    <div class="staff-section">
     <h4>ğŸ“Š Excelæª”æ¡ˆåŒ¯å…¥</h4>
     <div class="file-upload" onclick="document.getElementById('excelFile').click()"><input type="file" id="excelFile" accept=".xlsx,.xls,.csv" onchange="importExcel(event)">
      <p>ğŸ“ é»æ“Šä¸Šå‚³Excelæª”æ¡ˆ</p><small>æ”¯æ´æ ¼å¼ï¼š.xlsx, .xls, .csv<br>
       æ¬„ä½ï¼šå“¡å·¥ç·¨è™Ÿã€å§“åã€è·ä½ï¼ˆç·¨è¼¯/å½±ç‰‡/å¹³é¢ï¼‰</small>
     </div>
    </div>
    <div class="staff-section">
     <h4>â• æ‰‹å‹•æ–°å¢äººå“¡</h4>
     <div style="display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:12px; margin-bottom:16px"><input type="text" id="staffId" placeholder="å“¡å·¥ç·¨è™Ÿ"> <input type="text" id="staffName" placeholder="å§“å"> <select id="staffRole"> <option value="editor">ç·¨è¼¯</option> <option value="video">å½±ç‰‡</option> <option value="graphic">å¹³é¢</option> </select> <button class="btn" onclick="addStaff()">æ–°å¢</button>
     </div>
    </div>
    <div class="staff-section">
     <h4>âœï¸ ç·¨è¼¯äººå“¡ (<span id="editorCount">0</span>)</h4>
     <div id="editorList" class="staff-list"></div>
    </div>
    <div class="staff-section">
     <h4>ğŸ¬ å½±ç‰‡äººå“¡ (<span id="videoCount">0</span>)</h4>
     <div id="videoList" class="staff-list"></div>
    </div>
    <div class="staff-section">
     <h4>ğŸ¨ å¹³é¢äººå“¡ (<span id="graphicCount">0</span>)</h4>
     <div id="graphicList" class="staff-list"></div>
    </div>
    <div style="text-align:center; margin-top:32px"><button class="btn" onclick="closeModal('staffModal')">âœ… å®Œæˆ</button>
    </div>
   </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
// =================================================================
// ===== è¨­å®šå€ =====
// ï¼ï¼ï¼è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ Google Apps Script ç¶²å€ï¼ï¼ï¼
const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyhvS2XPcRJmAyu1ig2dFROfs3yBq3mpwkSeUn5_wmnzuE-0NUbpZvmu0S91t0qcz_C/exec";
// =================================================================

// å…¨åŸŸè®Šæ•¸
let newsData = [];
let staffData = { editor: [], video: [], graphic: [] };
let historyData = [];
let isAdminMode = false;
let editingId = null;
let autoDeleteTimer = null;
let filteredHistory = [];

// æœˆæ›†è®Šæ•¸
let calendarDate = new Date(); // ç•¶å‰æª¢è¦–çš„æœˆä»½

// æ§åˆ¶è¼‰å…¥ä¸­é®ç½©
function showLoading(show) {
  const overlay = document.getElementById('loadingOverlay');
  if (show) overlay.classList.add('show');
  else overlay.classList.remove('show');
}

// åˆ‡æ›æª¢è¦–æ¨¡å¼
function switchView(mode) {
  const newsContainer = document.getElementById('newsContainer');
  const calendarContainer = document.getElementById('calendarContainer');
  const btnBoard = document.getElementById('btnBoard');
  const btnCalendar = document.getElementById('btnCalendar');

  if (mode === 'board') {
    newsContainer.style.display = 'block';
    calendarContainer.style.display = 'none';
    btnBoard.classList.add('active');
    btnCalendar.classList.remove('active');
    renderNews(); // é‡æ–°æ¸²æŸ“çœ‹æ¿
  } else {
    newsContainer.style.display = 'none';
    calendarContainer.style.display = 'block';
    btnBoard.classList.remove('active');
    btnCalendar.classList.add('active');
    renderCalendar(); // æ¸²æŸ“æœˆæ›†
  }
}

// è·³è½‰åˆ°çœ‹æ¿æ¨¡å¼ä¸¦å®šä½
function jumpToBoard(newsId) {
    switchView('board');
    // ç­‰å¾… DOM æ¸²æŸ“å®Œæˆå¾ŒåŸ·è¡Œ
    setTimeout(() => {
        const element = document.getElementById(`news-${newsId}`);
        if (element) {
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // æ·»åŠ æš«æ™‚çš„é«˜äº®æ•ˆæœ
            element.classList.add('highlight-focus');
            setTimeout(() => {
                element.classList.remove('highlight-focus');
            }, 2000);
        }
    }, 100);
}

// æœˆæ›†åŠŸèƒ½ï¼šæ¸²æŸ“æœˆæ›†
function renderCalendar() {
  const grid = document.getElementById('calendarGrid');
  const monthLabel = document.getElementById('currentMonthLabel');
  const unscheduledList = document.getElementById('unscheduledList');
  const unscheduledArea = document.getElementById('unscheduledArea');

  grid.innerHTML = '';
  unscheduledList.innerHTML = '';
  
  const year = calendarDate.getFullYear();
  const month = calendarDate.getMonth();
  
  monthLabel.textContent = `${year}å¹´ ${month + 1}æœˆ`;
  
  // æ¸²æŸ“æ˜ŸæœŸæ¨™é¡Œ
  const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  days.forEach(day => {
    const div = document.createElement('div');
    div.className = 'calendar-day-header';
    div.textContent = day;
    grid.appendChild(div);
  });

  // è¨ˆç®—ç•¶æœˆå¤©æ•¸èˆ‡èµ·å§‹æ˜ŸæœŸ
  const firstDayOfMonth = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const daysInPrevMonth = new Date(year, month, 0).getDate();

  // æ¸²æŸ“ä¸Šå€‹æœˆçš„å‰©é¤˜å¤©æ•¸ (è£œé½Šæ ¼å­)
  for (let i = 0; i < firstDayOfMonth; i++) {
    const dayNum = daysInPrevMonth - firstDayOfMonth + 1 + i;
    const cell = createCalendarCell(dayNum, true);
    grid.appendChild(cell);
  }

  // å–å¾—çœŸå¯¦çš„ä»Šå¤©æ—¥æœŸ (ç”¨æ–¼è¨ˆç®—å…©å¤©å…§æ–°å¢)
  const today = new Date();
  today.setHours(0,0,0,0);

  // æ¸²æŸ“ç•¶æœˆå¤©æ•¸
  for (let i = 1; i <= daysInMonth; i++) {
    const cell = createCalendarCell(i, false);
    
    // æ§‹å»ºé€™å€‹æ ¼å­çš„æ—¥æœŸå­—ä¸² (YYYY-MM-DD)
    const currentDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
    const cellDate = new Date(year, month, i);
    
    // æ‰¾å‡ºç•¶å¤©çš„æ–°è (ç¢ºä¿è³‡æ–™åŒæ­¥)
    const daysNews = newsData.filter(n => n.date === currentDateStr);
    
    daysNews.forEach(news => {
      const event = document.createElement('div');
      event.className = 'calendar-event';
      
      // ===== æ–‡å­—é¡è‰²é‚è¼¯ =====
      // 1. åˆ¤æ–·æ˜¯å¦ç‚ºã€Œæ–°å¢å…©å¤©å…§ã€(æœ€å„ªå…ˆï¼Œç¶ è‰²å­—)
      let isNewlyAdded = false;
      if (news.createdDate) {
        const createdDate = new Date(news.createdDate);
        createdDate.setHours(0,0,0,0);
        const diffTime = Math.abs(today - createdDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        if (diffDays <= 1) { 
           isNewlyAdded = true;
        }
      }

      // 2. åˆ¤æ–·æ˜¯å¦ç‚ºã€Œä»Šå¤©ã€(ç´…è‰²å­—)
      const isToday = cellDate.toDateString() === today.toDateString();

      // 3. åˆ¤æ–·æ˜¯å¦ç‚ºã€Œé‡é»ã€(ç´«è‰²å­—)
      const isAccent = news.accent;

      // å¥—ç”¨ CSS Class (å„ªå…ˆç´šï¼šç¶  > ç´… > ç´« > é»‘)
      if (isNewlyAdded) {
        event.classList.add('text-green');
      } else if (isToday) {
        event.classList.add('text-red');
      } else if (isAccent) {
        event.classList.add('text-purple');
      } else {
        event.classList.add('text-black');
      }
      
      // ===== æ–‡å­—é•·åº¦é™åˆ¶ (10å€‹å­—) =====
      let displayTitle = news.title;
      if (displayTitle.length > 10) {
          displayTitle = displayTitle.substring(0, 10) + '...';
      }
      event.textContent = displayTitle;

      // é¡¯ç¤ºå‚™è¨»åœ¨ title tooltip ä¸­
      const tooltip = `${news.title}\n${news.note ? `å‚™è¨»: ${news.note}\n` : ''}ç·¨è¼¯: ${getStaffName('editor', news.editor)}`;
      event.title = tooltip;
      
      // é»æ“Šäº‹ä»¶ï¼šè·³è½‰åˆ°çœ‹æ¿æ¨¡å¼
      event.onclick = (e) => {
        e.stopPropagation();
        jumpToBoard(news.id);
      };
      
      cell.appendChild(event);
    });

    grid.appendChild(cell);
  }

  // è™•ç†æ—¥æœŸæœªå®šçš„æ–°è
  const unscheduledNews = newsData.filter(n => !n.date);
  if (unscheduledNews.length > 0) {
    unscheduledArea.style.display = 'block';
    unscheduledNews.forEach(news => {
      const event = document.createElement('div');
      event.className = 'calendar-event';
      
      // æœªå®šæ—¥æœŸçš„æ–‡å­—é¡è‰²é‚è¼¯ (ç¶  > ç´« > é»‘) - æ²’æœ‰ã€Œç•¶æ—¥ã€çš„æ¦‚å¿µ
      let isNewlyAdded = false;
      if (news.createdDate) {
        const createdDate = new Date(news.createdDate);
        createdDate.setHours(0,0,0,0);
        const diffTime = Math.abs(today - createdDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        if (diffDays <= 1) isNewlyAdded = true;
      }

      if (isNewlyAdded) event.classList.add('text-green');
      else if (news.accent) event.classList.add('text-purple');
      else event.classList.add('text-black');

      let displayTitle = news.title;
      if (displayTitle.length > 10) displayTitle = displayTitle.substring(0, 10) + '...';
      event.textContent = displayTitle;
      
      event.onclick = (e) => { 
          e.stopPropagation();
          jumpToBoard(news.id);
      };
      unscheduledList.appendChild(event);
    });
  } else {
    unscheduledArea.style.display = 'none';
  }
}

function createCalendarCell(dayNumber, isOtherMonth) {
  const cell = document.createElement('div');
  cell.className = `calendar-cell ${isOtherMonth ? 'other-month' : ''}`;
  cell.innerHTML = `<div class="day-number">${dayNumber}</div>`;
  return cell;
}

function changeMonth(offset) {
  calendarDate.setMonth(calendarDate.getMonth() + offset);
  renderCalendar();
}

// è¼”åŠ©ï¼šå–å¾—å“¡å·¥å§“å
function getStaffName(role, id) {
  const person = staffData[role]?.find(s => s.id == id);
  return person ? person.name : 'æœªæŒ‡æ´¾';
}


// è‡ªå‹•åˆªé™¤éæœŸæ–°èå‡½æ•¸
async function autoDeleteExpiredNews() {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const originalLength = newsData.length;
  
  // å°‡è¦åˆªé™¤çš„æ–°èåŠ å…¥æ­·å²ç´€éŒ„
  const expiredNews = newsData.filter(news => {
    if (!news.date) return false; 
    const newsDate = new Date(news.date);
    newsDate.setHours(0, 0, 0, 0);
    return newsDate < today;
  });
  
  // åŠ å…¥æ­·å²ç´€éŒ„ï¼ˆé¿å…é‡è¤‡ï¼‰
  expiredNews.forEach(news => {
    const exists = historyData.some(h => h.id == news.id && h.date === news.date);
    if (!exists) {
      historyData.push({
        ...news,
        archivedDate: new Date().toISOString().split('T')[0]
      });
    }
  });
  
  // ä¿ç•™ä»Šå¤©åŠä»¥å¾Œçš„æ–°è (æˆ–æ²’æœ‰æ—¥æœŸçš„)
  newsData = newsData.filter(news => {
    if (!news.date) return true;
    const newsDate = new Date(news.date);
    newsDate.setHours(0, 0, 0, 0);
    return newsDate >= today;
  });
  
  if (newsData.length < originalLength) {
    await saveData();
    console.log(`è‡ªå‹•åˆªé™¤äº† ${originalLength - newsData.length} å‰‡éæœŸæ–°è`);
  }
}

async function scheduleAutoDelete() {
  if (autoDeleteTimer) clearTimeout(autoDeleteTimer);
  
  const now = new Date();
  const tomorrow = new Date(now);
  tomorrow.setDate(tomorrow.getDate() + 1);
  tomorrow.setHours(0, 0, 0, 0);
  
  const timeUntilMidnight = tomorrow.getTime() - now.getTime();
  
  autoDeleteTimer = setTimeout(async () => {
    await autoDeleteExpiredNews();
    renderNews();
    if(document.getElementById('calendarContainer').style.display !== 'none') renderCalendar();
    updateAdminNewsList();
    
    setInterval(async () => {
      await autoDeleteExpiredNews();
      renderNews();
      if(document.getElementById('calendarContainer').style.display !== 'none') renderCalendar();
      updateAdminNewsList();
    }, 24 * 60 * 60 * 1000);
  }, timeUntilMidnight);
}

document.addEventListener('DOMContentLoaded', async function() {
  await loadData();
});

// æ¸²æŸ“æ–°èåˆ—è¡¨ (çœ‹æ¿æ¨¡å¼)
function renderNews() {
  const container = document.getElementById('newsContainer');
  container.innerHTML = '';
  
  scheduleAutoDelete();
  
  const today = new Date();
  // ç‚ºäº†è¨ˆç®—æ–°å¢å…©å¤©å…§ï¼Œå°‡æ™‚é–“æ­¸é›¶
  const todayMidnight = new Date();
  todayMidnight.setHours(0,0,0,0);
  
  const sortedNews = [...newsData].sort((a, b) => {
    const dateA = new Date(a.date);
    const dateB = new Date(b.date);
    const aHasDate = a.date && !isNaN(dateA.getTime());
    const bHasDate = b.date && !isNaN(dateB.getTime());

    if (aHasDate && !bHasDate) return -1;
    if (!aHasDate && bHasDate) return 1;
    if (!aHasDate && !bHasDate) return 0;
    
    const isToday = (date) => new Date(date).toDateString() === today.toDateString();
    const aIsToday = isToday(dateA);
    const bIsToday = isToday(dateB);
    
    if (aIsToday && !bIsToday) return -1;
    if (!aIsToday && bIsToday) return 1;
    
    return dateA - dateB;
  });
  
  sortedNews.forEach(news => {
    const newsDate = new Date(news.date);
    const isValidDate = news.date && !isNaN(newsDate.getTime()); 
    const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
    const dayOfWeek = isValidDate ? dayNames[newsDate.getDay()] : '-';
    const dateStr = isValidDate ? `${newsDate.getMonth() + 1}/${newsDate.getDate()}` : '--';
    const isToday = isValidDate && newsDate.toDateString() === today.toDateString();

    const editor = staffData.editor.find(s => s.id == news.editor);
    const video = staffData.video.find(s => s.id == news.video);
    const graphic = staffData.graphic.find(s => s.id == news.graphic);
    
    const card = document.createElement('section');
    card.id = `news-${news.id}`; // åŠ å…¥ ID ä»¥ä¾›è·³è½‰å®šä½
    let cardClass = 'card';
    let titleClass = '';
    
    // ===== æ–°å¢å…©å¤©å…§çš„åˆ¤æ–·é‚è¼¯ =====
    let isNewlyAdded = false;
    if (news.createdDate) {
      const createdDate = new Date(news.createdDate);
      createdDate.setHours(0,0,0,0);
      const diffTime = Math.abs(todayMidnight - createdDate);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      if (diffDays <= 1) {
        isNewlyAdded = true;
      }
    }
    // =============================
    
    // è¨­å®šæ¨£å¼å„ªå…ˆç´šï¼šç¶ (æ–°å¢) > ç´…(ä»Šå¤©) > ç´«(é‡é»)
    if (isNewlyAdded) {
        cardClass += ' green';
        titleClass = 'green';
    } else if (isToday) {
      cardClass += ' accent';
      titleClass = 'red';
    } else if (news.accent) {
      cardClass += ' purple';
      titleClass = 'purple';
    }
    
    card.className = cardClass;
    
    // ===== å‚™è¨»é¡¯ç¤ºé‚è¼¯ =====
    const noteHtml = news.note ? `<div class="note">å‚™è¨»ï¼š${news.note}</div>` : '';
    // ============================

    card.innerHTML = `
      <button class="edit-btn" onclick="editNews(${news.id})">ç·¨è¼¯</button>
      
      <div class="date">
        ${isValidDate ? `
          <div class="label">é è¨ˆç™¼å¸ƒ</div>
          <div class="day">${dateStr}</div>
          <div class="weekday">ç¦®æ‹œ${dayOfWeek}</div>
        ` : `
          <div class="label">æ—¥æœŸæœªå®š</div>
          <div class="day" style="font-size: 56px; color: var(--muted); line-height: 1;">${dateStr}</div>
          <div class="weekday"></div>
        `}
      </div>
      <div class="content">
        <h2 ${titleClass ? `class="${titleClass}"` : ''}>${news.title}</h2>
        ${noteHtml}
      </div>
      <aside class="meta">
        <div class="row"><span class="key">ç·¨è¼¯ï¼š</span>${news.editor || ''}ï¼ˆ${editor ? editor.name : 'æœªæŒ‡æ´¾'}ï¼‰</div>
        <div class="row"><span class="key">å½±ç‰‡ï¼š</span>${news.video || ''}ï¼ˆ${video ? video.name : 'æœªæŒ‡æ´¾'}ï¼‰</div>
        <div class="row"><span class="key">å¹³é¢ï¼š</span>${news.graphic || ''}ï¼ˆ${graphic ? graphic.name : 'æœªæŒ‡æ´¾'}ï¼‰</div>
      </aside>
    `;
    container.appendChild(card);
  });
}

// ç™»å…¥åŠŸèƒ½
function showLoginModal() {
  if (isAdminMode) {
    showStaffModal();
  } else {
    document.getElementById('loginModal').classList.add('show');
    document.getElementById('adminPassword').focus();
  }
}

function login() {
  const password = document.getElementById('adminPassword').value;
  if (password === 'cch4156') {
    isAdminMode = true;
    document.body.classList.add('admin-mode');
    document.querySelector('.admin-btn').textContent = 'ğŸ‘¥ äººå“¡ç®¡ç†';
    closeModal('loginModal');
    document.getElementById('adminPassword').value = '';
    showNotification('âœ… ç™»å…¥æˆåŠŸï¼ç¾åœ¨å¯ä»¥ç·¨è¼¯æ–°èå…§å®¹äº†ã€‚', 'success');
  } else {
    showNotification('âŒ å¯†ç¢¼éŒ¯èª¤ï¼è«‹é‡æ–°è¼¸å…¥ã€‚', 'error');
    document.getElementById('adminPassword').value = '';
    document.getElementById('adminPassword').focus();
  }
}

// æ–°èç·¨è¼¯åŠŸèƒ½
function editNews(id) {
  if (!isAdminMode) return;
  
  const news = newsData.find(n => n.id == id);
  if (!news) return;
  
  editingId = id;
  document.getElementById('editTitle').textContent = 'ğŸ“ ç·¨è¼¯æ–°è';
  
  // ===== ä¿®æ­£é‡é»ï¼šå¼·åˆ¶æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DDï¼Œç¢ºä¿ input type="date" èƒ½æ­£ç¢ºé¡¯ç¤º =====
  if (news.date) {
    const d = new Date(news.date);
    if (!isNaN(d.getTime())) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      document.getElementById('editDate').value = `${yyyy}-${mm}-${dd}`;
    } else {
      document.getElementById('editDate').value = '';
    }
  } else {
    document.getElementById('editDate').value = '';
  }
  // ==============================================================================

  document.getElementById('editNewsTitle').value = news.title;
  
  // ===== è®€å–å‚™è¨» =====
  document.getElementById('editNewsNote').value = news.note || ''; 
  // ========================
  
  document.getElementById('editAccent').checked = news.accent;
  document.getElementById('deleteBtn').style.display = 'inline-block';
  
  updateStaffSelects();
  document.getElementById('editEditor').value = news.editor;
  document.getElementById('editVideo').value = news.video;
  document.getElementById('editGraphic').value = news.graphic;
  
  document.getElementById('editModal').classList.add('show');
}

function addNews() {
  editingId = null;
  document.getElementById('editTitle').textContent = 'â• æ–°å¢æ–°è';
  document.getElementById('editDate').value = '';
  document.getElementById('editNewsTitle').value = '';
  document.getElementById('editNewsNote').value = ''; // æ¸…ç©ºå‚™è¨»
  document.getElementById('editAccent').checked = false;
  document.getElementById('deleteBtn').style.display = 'none';
  
  updateStaffSelects();
  document.getElementById('editEditor').value = '';
  document.getElementById('editVideo').value = '';
  document.getElementById('editGraphic').value = '';
  
  document.getElementById('editModal').classList.add('show');
}

async function saveNews() {
  const date = document.getElementById('editDate').value;
  const title = document.getElementById('editNewsTitle').value.trim();
  const note = document.getElementById('editNewsNote').value.trim(); // å–å¾—å‚™è¨»
  const editor = document.getElementById('editEditor').value;
  const video = document.getElementById('editVideo').value;
  const graphic = document.getElementById('editGraphic').value;
  const accent = document.getElementById('editAccent').checked;
  
  if (!title) {
    showNotification('âš ï¸ è«‹å¡«å¯«æ–°èæ¨™é¡Œï¼', 'warning');
    return;
  }
  
  // å¦‚æœæ˜¯æ–°å¢æ–°èï¼Œè¨˜éŒ„ä»Šå¤©çš„æ—¥æœŸä½œç‚º createdDate
  // å¦‚æœæ˜¯ç·¨è¼¯ï¼Œä¿ç•™åŸæœ‰çš„ createdDate (å¾ newsData ä¸­æŸ¥æ‰¾)
  let createdDate = '';
  
  if (editingId) {
    // ç·¨è¼¯æ¨¡å¼ï¼šä¿ç•™åŸæœ‰çš„å»ºç«‹æ—¥æœŸ
    const index = newsData.findIndex(n => n.id == editingId);
    const originalNews = newsData[index];
    createdDate = originalNews.createdDate || ''; // å¦‚æœåŸæœ¬æ²’æœ‰ï¼Œå°±ç•™ç©º
    
    newsData[index] = {
      id: editingId,
      date, title, note, editor, video, graphic, accent, createdDate
    };
    showNotification('âœ… æ–°èæ›´æ–°æˆåŠŸï¼', 'success');
  } else {
    // æ–°å¢æ¨¡å¼ï¼šè¨˜éŒ„ä»Šå¤©
    const maxId = newsData.length > 0 ? Math.max(...newsData.map(n => Number(n.id) || 0)) : 0;
    const newId = maxId + 1;
    createdDate = new Date().toISOString().split('T')[0]; // æ ¼å¼: YYYY-MM-DD
    
    newsData.push({
      id: newId,
      date, title, note, editor, video, graphic, accent, createdDate
    });
    showNotification('âœ… æ–°èæ–°å¢æˆåŠŸï¼', 'success');
  }
  
  await saveData();
  renderNews();
  // ç¢ºä¿æœˆæ›†æ¨¡å¼ä¹Ÿæœƒæ›´æ–°
  if(document.getElementById('calendarContainer').style.display !== 'none') renderCalendar();
  closeModal('editModal');
}

function deleteNews() {
  if (!editingId) return;
  
  showConfirmDialog('âš ï¸ ç¢ºå®šè¦å®Œæˆé€™å‰‡æ–°èå—ï¼Ÿå®Œæˆå¾Œæœƒç§»è‡³æ­·å²ç´€éŒ„ã€‚', async () => {
    const newsToDelete = newsData.find(n => n.id == editingId);
    if (newsToDelete) {
      const exists = historyData.some(h => h.id == newsToDelete.id && h.date === newsToDelete.date);
      if (!exists) {
        historyData.push({
          ...newsToDelete,
          archivedDate: new Date().toISOString().split('T')[0]
        });
      }
      
      newsData = newsData.filter(n => n.id != editingId);
      
      await saveData();
      renderNews();
      // ç¢ºä¿æœˆæ›†æ¨¡å¼ä¹Ÿæœƒæ›´æ–°
      if(document.getElementById('calendarContainer').style.display !== 'none') renderCalendar();
      updateAdminNewsList();
      closeModal('editModal');
      showNotification('âœ… æ–°èå·²å®Œæˆä¸¦ç§»è‡³æ­·å²ç´€éŒ„ï¼', 'success');
    }
  });
}

// äººå“¡ç®¡ç†åŠŸèƒ½
function showStaffModal() {
  updateStaffLists();
  updateAdminNewsList();
  document.getElementById('staffModal').classList.add('show');
}

function updateAdminNewsList() {
  const container = document.getElementById('adminNewsList');
  container.innerHTML = '';
  
  if (newsData.length === 0) {
    container.innerHTML = '<p style="text-align:center; color:var(--muted); margin:20px 0">ç›®å‰æ²’æœ‰æ–°èè³‡æ–™</p>';
    return;
  }
  
  const sortedNews = [...newsData].sort((a, b) => {
    const dateA = new Date(a.date);
    const dateB = new Date(b.date);
    const aHasDate = a.date && !isNaN(dateA.getTime());
    const bHasDate = b.date && !isNaN(dateB.getTime());

    if (aHasDate && !bHasDate) return -1;
    if (!aHasDate && bHasDate) return 1;
    if (!aHasDate && !bHasDate) return 0;
    
    return dateA - dateB;
  });
  
  sortedNews.forEach(news => {
    const newsDate = new Date(news.date);
    const isValidDate = news.date && !isNaN(newsDate.getTime());
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const isToday = isValidDate && newsDate.toDateString() === today.toDateString();
    
    const editor = staffData.editor.find(s => s.id == news.editor);
    const video = staffData.video.find(s => s.id == news.video);
    const graphic = staffData.graphic.find(s => s.id == news.graphic);
    
    const newsItem = document.createElement('div');
    
    let bgColor = '#fff';
    let borderColor = 'var(--line)';
    let titleColor = 'var(--ink)';
    let starIcon = '';
    
    if (isToday) {
      bgColor = 'var(--soft-red)';
      borderColor = 'var(--soft-red-line)';
      titleColor = 'var(--accent)';
      starIcon = 'ğŸ”´';
    } else if (news.accent) {
      bgColor = 'var(--soft-purple)';
      borderColor = 'var(--soft-purple-line)';
      titleColor = 'var(--purple)';
      starIcon = 'ğŸŸ£';
    }
    
    newsItem.style.cssText = `
      border: 1px solid ${borderColor}; border-radius: 8px; padding: 12px; margin: 8px 0;
      background: ${bgColor};
    `;
    
    newsItem.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px">
        <div style="flex: 1">
          <div style="font-size: 14px; color: var(--muted); margin-bottom: 4px">
            ğŸ“… ${isValidDate ? news.date : 'æ—¥æœŸæœªå®š'} ${starIcon}
          </div>
          <div style="font-weight: 600; margin-bottom: 8px; color: ${titleColor}">
            ${news.title}
          </div>
          <div style="font-size: 12px; color: var(--muted)">
            ç·¨è¼¯ï¼š${editor ? editor.name : 'æœªæŒ‡æ´¾'} | 
            å½±ç‰‡ï¼š${video ? video.name : 'æœªæŒ‡æ´¾'} | 
            å¹³é¢ï¼š${graphic ? graphic.name : 'æœªæŒ‡æ´¾'}
          </div>
        </div>
        <button onclick="editNews(${news.id})" style="
          background: var(--green); color: white; border: none; padding: 6px 12px;
          border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;
        ">ç·¨è¼¯</button>
      </div>
    `;
    
    container.appendChild(newsItem);
  });
}

function updateStaffSelects() {
  const selects = ['editEditor', 'editVideo', 'editGraphic'];
  const roles = ['editor', 'video', 'graphic'];
  
  selects.forEach((selectId, index) => {
    const select = document.getElementById(selectId);
    const currentValue = select.value;
    select.innerHTML = `<option value="">è«‹é¸æ“‡${roles[index] === 'editor' ? 'ç·¨è¼¯' : roles[index] === 'video' ? 'å½±ç‰‡' : 'å¹³é¢'}äººå“¡</option>`;
    
    if (staffData[roles[index]]) {
      staffData[roles[index]].forEach(staff => {
        const option = document.createElement('option');
        option.value = staff.id;
        option.textContent = `${staff.id}ï¼ˆ${staff.name}ï¼‰`;
        select.appendChild(option);
      });
    }
    select.value = currentValue;
  });
}

function updateStaffLists() {
  const roles = ['editor', 'video', 'graphic'];
  roles.forEach(role => {
    const container = document.getElementById(`${role}List`);
    const count = document.getElementById(`${role}Count`);
    container.innerHTML = '';
    
    if (staffData[role]) {
      count.textContent = staffData[role].length;
      staffData[role].forEach(staff => {
        const item = document.createElement('div');
        item.className = 'staff-item';
        item.innerHTML = `
          <span><strong>${staff.id}</strong>ï¼ˆ${staff.name}ï¼‰</span>
          <button class="remove-staff" onclick="removeStaff('${role}', '${staff.id}')">ç§»é™¤</button>
        `;
        container.appendChild(item);
      });
    } else {
      count.textContent = 0;
    }
  });
}

async function addStaff() {
  const id = document.getElementById('staffId').value.trim();
  const name = document.getElementById('staffName').value.trim();
  const role = document.getElementById('staffRole').value;
  
  if (!id || !name) {
    showNotification('âš ï¸ è«‹å¡«å¯«å“¡å·¥ç·¨è™Ÿå’Œå§“åï¼', 'warning');
    return;
  }
  
  const exists = Object.values(staffData).some(roleStaff => 
    roleStaff.some(staff => staff.id == id)
  );
  
  if (exists) {
    showNotification('âš ï¸ è©²å“¡å·¥ç·¨è™Ÿå·²å­˜åœ¨ï¼', 'warning');
    return;
  }
  
  staffData[role].push({id, name});
  document.getElementById('staffId').value = '';
  document.getElementById('staffName').value = '';
  
  updateStaffLists();
  updateStaffSelects();
  await saveData();
  showNotification('âœ… äººå“¡æ–°å¢æˆåŠŸï¼', 'success');
}

function removeStaff(role, id) {
  showConfirmDialog('âš ï¸ ç¢ºå®šè¦ç§»é™¤é€™ä½äººå“¡å—ï¼Ÿ', async () => {
    staffData[role] = staffData[role].filter(staff => staff.id != id);
    updateStaffLists();
    updateStaffSelects();
    await saveData();
    showNotification('âœ… äººå“¡å·²ç§»é™¤ï¼', 'success');
  });
}

// Excelä¸‹è¼‰èˆ‡æ­·å²æœå°‹åŠŸèƒ½
function downloadHistoryExcel() {
  if (filteredHistory.length === 0) {
    showNotification('âš ï¸ æ²’æœ‰è³‡æ–™å¯ä»¥ä¸‹è¼‰ï¼è«‹å…ˆæœå°‹æˆ–ç¢ºèªæœ‰æ­·å²ç´€éŒ„ã€‚', 'warning');
    return;
  }
  const excelData = [];
  const year = document.getElementById('searchYear').value;
  const month = document.getElementById('searchMonth').value;
  const keyword = document.getElementById('searchKeyword').value.trim();
  
  let fileName = 'æ–°èæ­·å²ç´€éŒ„';
  const currentDate = new Date().toISOString().split('T')[0];
  
  if (year || month || keyword) fileName += '_ç¯©é¸çµæœ';
  fileName += `_${currentDate}.xlsx`;
  
  const sortedData = [...filteredHistory].sort((a, b) => {
    const dateA = new Date(a.date);
    const dateB = new Date(b.date);
    const aHasDate = a.date && !isNaN(dateA.getTime());
    const bHasDate = b.date && !isNaN(dateB.getTime());
    if (aHasDate && !bHasDate) return 1;
    if (!aHasDate && bHasDate) return -1;
    if (!aHasDate && !bHasDate) return 0;
    return dateB - dateA;
  });
  
  sortedData.forEach((news, index) => {
    const newsDate = new Date(news.date);
    const isValidDate = news.date && !isNaN(newsDate.getTime());
    const editor = staffData.editor.find(s => s.id == news.editor);
    const video = staffData.video.find(s => s.id == news.video);
    const graphic = staffData.graphic.find(s => s.id == news.graphic);
    
    excelData.push({
      'åºè™Ÿ': index + 1,
      'ç™¼å¸ƒæ—¥æœŸ': news.date || 'æ—¥æœŸæœªå®š',
      'å¹´ä»½': isValidDate ? newsDate.getFullYear() : '',
      'æœˆä»½': isValidDate ? newsDate.getMonth() + 1 : '',
      'æ–°èæ¨™é¡Œ': news.title,
      'å‚™è¨»èªªæ˜': news.note || '', // æ–°å¢å‚™è¨»
      'é‡é»æ–°è': news.accent ? 'æ˜¯' : 'å¦',
      'ç·¨è¼¯äººå“¡': editor ? editor.name : 'å·²é›¢è·/æœªæŒ‡æ´¾',
      'å½±ç‰‡äººå“¡': video ? video.name : 'å·²é›¢è·/æœªæŒ‡æ´¾',
      'å¹³é¢äººå“¡': graphic ? graphic.name : 'å·²é›¢è·/æœªæŒ‡æ´¾',
      'æ­¸æª”æ—¥æœŸ': news.archivedDate || 'æ‰‹å‹•æ­¸æª”'
    });
  });
  
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(excelData);
  XLSX.utils.book_append_sheet(wb, ws, 'æ–°èæ­·å²ç´€éŒ„');
  XLSX.writeFile(wb, fileName);
}

async function importExcel(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const worksheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(worksheet);
      
      let imported = 0;
      jsonData.forEach((row) => {
        const id = String(row['å“¡å·¥ç·¨è™Ÿ'] || row['ç·¨è™Ÿ'] || '').trim();
        const name = String(row['å§“å'] || row['åå­—'] || '').trim();
        const roleText = String(row['è·ä½'] || row['è§’è‰²'] || '').trim().toLowerCase();
        
        let targetRole = '';
        if (roleText.includes('ç·¨è¼¯')) targetRole = 'editor';
        else if (roleText.includes('å½±ç‰‡')) targetRole = 'video';
        else if (roleText.includes('å¹³é¢')) targetRole = 'graphic';
        else return;
        
        const exists = Object.values(staffData).some(roleStaff => 
          roleStaff.some(staff => staff.id == id)
        );
        
        if (!exists && id && name) {
          staffData[targetRole].push({id, name});
          imported++;
        }
      });
      
      updateStaffLists();
      updateStaffSelects();
      await saveData();
      showNotification(`âœ… æˆåŠŸåŒ¯å…¥ ${imported} ç­†äººå“¡è³‡æ–™ï¼`, 'success');
    } catch (error) {
      showNotification('âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼', 'error');
    }
  };
  reader.readAsArrayBuffer(file);
  event.target.value = '';
}

function showHistoryModal() {
  updateYearOptions();
  clearSearch();
  document.getElementById('historyModal').classList.add('show');
}

function updateYearOptions() {
  const yearSelect = document.getElementById('searchYear');
  const currentYear = new Date().getFullYear();
  const years = new Set();
  historyData.forEach(news => { if (news.date) years.add(new Date(news.date).getFullYear()); });
  const startYear = 2024;
  for (let i = startYear; i <= currentYear + 1; i++) years.add(i);
  yearSelect.innerHTML = '<option value="">é¸æ“‡å¹´ä»½</option>';
  [...years].sort((a, b) => b - a).forEach(year => yearSelect.innerHTML += `<option value="${year}">${year}å¹´</option>`);
}

function searchHistory() {
  const year = document.getElementById('searchYear').value;
  const month = document.getElementById('searchMonth').value;
  const keyword = document.getElementById('searchKeyword').value.trim().toLowerCase();
  
  filteredHistory = historyData.filter(news => {
    const newsDate = new Date(news.date);
    const isValidDate = news.date && !isNaN(newsDate.getTime());
    if (year && (!isValidDate || newsDate.getFullYear() !== parseInt(year))) return false;
    if (month && (!isValidDate || (newsDate.getMonth() + 1) !== parseInt(month))) return false;
    if (keyword && !news.title.toLowerCase().includes(keyword) && !(news.note || '').toLowerCase().includes(keyword)) return false;
    return true;
  });
  displayHistoryResults();
}

function clearSearch() {
  document.getElementById('searchYear').value = '';
  document.getElementById('searchMonth').value = '';
  document.getElementById('searchKeyword').value = '';
  filteredHistory = [...historyData];
  displayHistoryResults();
}

function displayHistoryResults() {
  const container = document.getElementById('historyList');
  document.getElementById('historyCount').textContent = filteredHistory.length;
  container.innerHTML = '';
  
  if (filteredHistory.length === 0) {
    container.innerHTML = '<p style="text-align:center; color:var(--muted); margin:20px 0">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„æ­·å²æ–°è</p>';
    return;
  }
  
  const sortedHistory = [...filteredHistory].sort((a, b) => {
    const dateA = new Date(a.date);
    const dateB = new Date(b.date);
    const aHasDate = a.date && !isNaN(dateA.getTime());
    const bHasDate = b.date && !isNaN(dateB.getTime());
    if (aHasDate && !bHasDate) return 1;
    if (!aHasDate && bHasDate) return -1;
    if (!aHasDate && !bHasDate) return 0;
    return dateB - dateA;
  });
  
  sortedHistory.forEach(news => {
    const newsDate = new Date(news.date);
    const isValidDate = news.date && !isNaN(newsDate.getTime());
    const editor = staffData.editor.find(s => s.id == news.editor);
    const video = staffData.video.find(s => s.id == news.video);
    const graphic = staffData.graphic.find(s => s.id == news.graphic);
    
    const div = document.createElement('div');
    const bgColor = news.accent ? 'var(--soft-purple)' : '#fff';
    const borderColor = news.accent ? 'var(--soft-purple-line)' : 'var(--line)';
    
    div.style.cssText = `border: 1px solid ${borderColor}; border-radius: 8px; padding: 12px; margin: 8px 0; background: ${bgColor};`;
    div.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px">
        <div style="flex: 1">
          <div style="font-size: 14px; color: var(--muted); margin-bottom: 4px">
            ğŸ“… ${isValidDate ? news.date : 'æ—¥æœŸæœªå®š'} ${news.archivedDate ? `æ­¸æª”:${news.archivedDate}` : ''}
          </div>
          <div style="font-weight: 600; margin-bottom: 4px; color: var(--ink)">${news.title}</div>
          ${news.note ? `<div style="font-size: 13px; color: var(--muted); margin-bottom: 8px">${news.note}</div>` : ''}
          <div style="font-size: 12px; color: var(--muted)">
            ç·¨è¼¯ï¼š${editor ? editor.name : 'æœªæŒ‡æ´¾'} | å½±ç‰‡ï¼š${video ? video.name : 'æœªæŒ‡æ´¾'} | å¹³é¢ï¼š${graphic ? graphic.name : 'æœªæŒ‡æ´¾'}
          </div>
        </div>
        <div>
           <button onclick="restoreNews('${news.id}', '${news.date || ''}')" style="background:var(--green);color:white;border:none;padding:4px 8px;border-radius:4px;font-size:11px;">å¾©åŸ</button>
           <button onclick="permanentDeleteNews('${news.id}', '${news.date || ''}')" style="background:var(--accent);color:white;border:none;padding:4px 8px;border-radius:4px;font-size:11px;margin-top:4px;">åˆªé™¤</button>
        </div>
      </div>
    `;
    container.appendChild(div);
  });
}

function restoreNews(id, date) {
  if (!isAdminMode) return showNotification('âŒ è«‹å…ˆç™»å…¥ç®¡ç†å¾Œå°ï¼', 'error');
  showConfirmDialog('âš ï¸ ç¢ºå®šè¦å¾©åŸé€™å‰‡æ–°èå—ï¼Ÿ', async () => {
    const historyNews = historyData.find(h => h.id == id && (h.date || '') === date);
    if (historyNews) {
      const { archivedDate, ...restoredNews } = historyNews;
      newsData.push(restoredNews);
      historyData = historyData.filter(h => !(h.id == id && (h.date || '') === date));
      filteredHistory = filteredHistory.filter(h => !(h.id == id && (h.date || '') === date));
      await saveData();
      renderNews();
      updateAdminNewsList();
      closeModal('historyModal');
      showNotification('âœ… æ–°èå·²å¾©åŸï¼', 'success');
    }
  });
}

function permanentDeleteNews(id, date) {
  if (!isAdminMode) return showNotification('âŒ è«‹å…ˆç™»å…¥ç®¡ç†å¾Œå°ï¼', 'error');
  showConfirmDialog('âš ï¸ ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤å—ï¼Ÿ', async () => {
    historyData = historyData.filter(h => !(h.id == id && (h.date || '') === date));
    filteredHistory = filteredHistory.filter(h => !(h.id == id && (h.date || '') === date));
    await saveData();
    displayHistoryResults();
    showNotification('âœ… å·²æ°¸ä¹…åˆªé™¤ï¼', 'success');
  });
}

// å„²å­˜è³‡æ–™
async function saveData() {
  showLoading(true);
  try {
    const payload = {
      action: "saveAll",
      newsData: newsData,
      staffData: staffData,
      historyData: historyData
    };
    const response = await fetch(GAS_WEB_APP_URL, {
      method: 'POST',
      body: JSON.stringify(payload),
      headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    });
    const result = await response.json();
    if (result.status !== 'success') throw new Error(result.message);
  } catch (error) {
    showNotification('âŒ å„²å­˜è³‡æ–™å¤±æ•—ï¼', 'error');
    console.error(error);
  } finally {
    showLoading(false);
  }
}

// è¼‰å…¥è³‡æ–™
async function loadData() {
  showLoading(true);
  try {
    const response = await fetch(`${GAS_WEB_APP_URL}?action=loadAll`);
    const data = await response.json();
    if (data.status === 'error') throw new Error(data.message);
    
    newsData = data.news || [];
    staffData = data.staff || { editor: [], video: [], graphic: [] };
    historyData = data.history || [];
    
    await autoDeleteExpiredNews();
    renderNews();
  } catch (error) {
    showNotification('âŒ è¼‰å…¥è³‡æ–™å¤±æ•—ï¼', 'error');
    document.getElementById('newsContainer').innerHTML = '<h2 style="text-align:center;color:var(--accent)">è¼‰å…¥å¤±æ•—</h2>';
  } finally {
    showLoading(false);
  }
}

// UI è¼”åŠ©
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
document.addEventListener('click', e => { if(e.target.classList.contains('modal')) e.target.classList.remove('show'); });
document.addEventListener('keydown', e => { if(e.key === 'Escape') document.querySelectorAll('.modal.show').forEach(m => m.classList.remove('show')); });

function showNotification(msg, type='info') {
  const div = document.createElement('div');
  div.className = 'notification';
  div.textContent = msg;
  div.style.cssText = `position:fixed;top:80px;right:20px;background:${type=='error'?'#DC2626':type=='success'?'#059669':'#2563EB'};color:white;padding:16px;border-radius:8px;z-index:10000;animation:slideIn 0.3s;`;
  document.body.appendChild(div);
  setTimeout(() => div.remove(), 3000);
}

function showConfirmDialog(msg, onConfirm) {
  const overlay = document.createElement('div');
  overlay.className = 'confirm-dialog';
  overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10001;';
  overlay.innerHTML = `<div style="background:white;padding:32px;border-radius:16px;text-align:center;"><p style="margin-bottom:24px;">${msg}</p><button class="btn danger" onclick="confirmAction()">ç¢ºå®š</button> <button class="btn secondary" onclick="cancelAction()">å–æ¶ˆ</button></div>`;
  document.body.appendChild(overlay);
  
  window.confirmAction = () => { overlay.remove(); onConfirm(); };
  window.cancelAction = () => { overlay.remove(); };
  overlay.onclick = e => { if(e.target===overlay) window.cancelAction(); };
}

// æ³¨å…¥å‹•ç•«æ¨£å¼
const style = document.createElement('style');
style.textContent = `@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }`;
document.head.appendChild(style);
</script>
</body>
</html>


